<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ödeal Mail</title>
    <!-- Tailwind CSS kütüphanesini projeye dahil ediyoruz -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter yazı tipi için -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Ekranın tamamını kaplaması ve kaydırma çubuklarının doğru çalışması için */
        html, body {
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        /* Panellerin kendi içinde kaydırılabilir olması için */
        .scrollable {
            overflow-y: auto;
            height: 100vh;
        }
        /* Seçili mesajın arka plan rengini ve sol kenarlığını belirlemek için */
        .selected-message {
            background-color: #eef2ff; /* indigo-50 */
            border-left-color: #4f46e5 !important; /* indigo-600 */
        }
        /* Webkit tabanlı tarayıcılar için daha ince ve estetik scrollbar */
        .scrollable::-webkit-scrollbar {
            width: 6px;
        }
        .scrollable::-webkit-scrollbar-track {
            background: transparent;
        }
        .scrollable::-webkit-scrollbar-thumb {
            background-color: #d1d5db; /* gray-400 */
            border-radius: 20px;
            border: 3px solid transparent;
        }
    </style>
</head>
<body class="bg-slate-100">
    <div id="app" class="flex h-screen">
        <!-- Sol Panel: Kullanıcı Seçimi ve Gelen Kutusu -->
        <aside class="w-1/3 bg-white border-r border-slate-200 flex flex-col scrollable">
            <!-- Başlık ve Kullanıcı Seçimi -->
            <header class="p-4 border-b border-slate-200 sticky top-0 bg-white z-10">
                <div class="flex items-center space-x-3">
                    <div class="p-2 bg-indigo-600 rounded-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                    </div>
                    <h1 class="text-xl font-bold text-slate-800">Ödeal Mail</h1>
                </div>
                <div class="mt-4">
                    <label for="user-select" class="text-sm font-medium text-slate-600">Giriş Yapan Kullanıcı:</label>
                    <select id="user-select" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        <!-- Kullanıcılar buraya dinamik olarak eklenecek -->
                    </select>
                </div>
            </header>

            <!-- Gelen Kutusu -->
            <div id="inbox" class="flex-grow p-2">
                <div class="flex justify-between items-center mb-2 p-2">
                    <h2 class="text-lg font-semibold text-slate-700">Gelen Kutusu</h2>
                    <div id="polling-status" class="flex items-center text-sm text-slate-500 italic">
                        <!-- Durum mesajı ve ikonu buraya gelecek -->
                    </div>
                </div>
                <div id="message-list" class="space-y-1">
                    <!-- Mesajlar buraya dinamik olarak eklenecek -->
                </div>
            </div>
        </aside>

        <!-- Sağ Panel: Mesaj Okuma ve Yazma -->
        <main class="w-2/3 flex flex-col bg-slate-50 scrollable">
            <div id="message-view" class="p-6 md:p-8 flex-grow">
                <!-- Seçili mesaj burada gösterilecek -->
                <div class="flex flex-col items-center justify-center h-full text-center text-slate-500">
                    <svg class="w-16 h-16 text-slate-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 5.523-4.477 10-10 10S1 17.523 1 12 5.477 2 11 2s10 4.477 10 10z"></path></svg>
                    <p>Okumak için bir mesaj seçin.</p>
                </div>
            </div>
            
            <!-- Yeni Mesaj Oluşturma Formu -->
            <div id="compose-view" class="p-4 bg-white border-t border-slate-200 sticky bottom-0">
                <form id="compose-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                        <select id="compose-to" class="w-full p-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                            <!-- Alıcılar buraya eklenecek -->
                        </select>
                        <input type="text" id="compose-subject" placeholder="Konu" class="w-full p-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <textarea id="compose-body" rows="4" placeholder="Mesajınızı buraya yazın..." class="w-full p-2 border border-slate-300 rounded-md mb-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required></textarea>
                    <div class="flex justify-end">
                        <button type="submit" class="inline-flex items-center px-6 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">
                            Gönder
                            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- AYARLAR ---
            const API_URL = 'https://stajwithrabbit.onrender.com'; // KENDİ RENDER URL'İNİ BURAYA YAPIŞTIR!
            const POLLING_INTERVAL_MS = 3000; // 3 saniyede bir yeni mesajları kontrol et

            // --- Elementleri Seçme ---
            const userSelect = document.getElementById('user-select');
            const messageList = document.getElementById('message-list');
            const messageView = document.getElementById('message-view');
            const composeForm = document.getElementById('compose-form');
            const composeTo = document.getElementById('compose-to');
            const pollingStatus = document.getElementById('polling-status');

            // --- Durum Değişkenleri ---
            let allUsers = [];
            let currentUser = null;
            let pollingIntervalId = null;

            // --- FONKSİYONLAR ---

            // 1. Tüm kullanıcıları API'den çek ve seçim kutularını doldur
            async function populateUsers() {
                try {
                    const response = await fetch(`${API_URL}/users`);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`API'den hatalı yanıt alındı: ${response.status} ${response.statusText}`);
                        console.error('Gelen yanıt:', errorText);
                        alert(`API sunucusundan hata alındı: ${response.status}. Detaylar için tarayıcı konsolunu kontrol edin.`);
                        return;
                    }
                    
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        allUsers = await response.json();
                    } else {
                        const responseText = await response.text();
                        console.error("API'den JSON formatında yanıt bekleniyordu fakat farklı bir format geldi.");
                        console.error("Gelen yanıt:", responseText);
                        alert("Sunucudan beklenmedik formatta bir yanıt alındı. Detaylar için tarayıcı konsolunu kontrol edin.");
                        return;
                    }

                    userSelect.innerHTML = '';
                    composeTo.innerHTML = '<option value="" disabled selected>Alıcı Seçin...</option>';

                    allUsers.forEach(user => {
                        const option = new Option(user.name, user.id);
                        userSelect.appendChild(option.cloneNode(true));
                        composeTo.appendChild(option);
                    });
                    
                    if(allUsers.length > 0) {
                        handleUserLogin(allUsers[0].id);
                    }
                } catch (error) {
                    console.error('Kullanıcılar çekilirken bir ağ hatası oluştu:', error);
                    alert('API sunucusuna bağlanılamadı. Ağ bağlantınızı veya sunucu durumunu kontrol edin.');
                }
            }

            // 2. Kullanıcı giriş yaptığında veya değiştirdiğinde çalışacak ana fonksiyon
            function handleUserLogin(userId) {
                const selectedUserId = parseInt(userId);
                currentUser = allUsers.find(u => u.id === selectedUserId);
                
                if (!currentUser) return;

                console.log(`Kullanıcı değişti: ${currentUser.name} (ID: ${currentUser.id})`);
                
                messageList.innerHTML = '<div class="text-center text-slate-500 p-4">Mesajlar yükleniyor...</div>';
                messageView.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-center text-slate-500"><svg class="w-16 h-16 text-slate-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 5.523-4.477 10-10 10S1 17.523 1 12 5.477 2 11 2s10 4.477 10 10z"></path></svg><p>Okumak için bir mesaj seçin.</p></div>';
                userSelect.value = currentUser.id;

                startPolling();
            }

            // 3. Otomatik mesaj kontrolünü (Polling) başlatan fonksiyon
            function startPolling() {
                if (pollingIntervalId) clearInterval(pollingIntervalId);
                checkForMessages();
                pollingIntervalId = setInterval(checkForMessages, POLLING_INTERVAL_MS);
            }

            // 4. Yeni mesajları kontrol etmek için sunucuya istek atan fonksiyon
            async function checkForMessages() {
                if (!currentUser) return;
                pollingStatus.innerHTML = `<svg class="w-4 h-4 text-slate-400 animate-spin mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path clip-rule="evenodd" d="M12 19C15.866 19 19 15.866 19 12C19 8.13401 15.866 5 12 5C8.13401 5 5 8.13401 5 12C5 15.866 8.13401 19 12 19ZM12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" fill="currentColor" fill-rule="evenodd" opacity="0.2"></path><path d="M2 12C2 6.47715 6.47715 2 12 2V5C8.13401 5 5 8.13401 5 12H2Z" fill="currentColor"></path></svg> Kontrol ediliyor...`;

                try {
                    const response = await fetch(`${API_URL}/messages/check/${currentUser.id}`);
                    
                    if (!response.ok) {
                        console.error(`Mesaj kontrol hatası (status): ${response.status}`);
                        pollingStatus.innerHTML = `<span class="w-2 h-2 bg-red-400 rounded-full mr-2"></span> Hata`;
                        return;
                    }

                    const data = await response.json();

                    if (data.status === 'ok' && data.message) {
                        displayMessageInList(data.message);
                        setTimeout(checkForMessages, 100); // Bir mesaj daha olabilir, hemen tekrar kontrol et
                    } else {
                        pollingStatus.innerHTML = `<span class="w-2 h-2 bg-green-400 rounded-full mr-2"></span> Güncel`;
                    }
                } catch (error) {
                    console.error('Mesaj kontrolü sırasında kritik hata:', error);
                    pollingStatus.innerHTML = `<span class="w-2 h-2 bg-red-400 rounded-full mr-2"></span> Hata`;
                }
            }

            // 5. Gelen mesajı sol taraftaki listeye ekler
            function displayMessageInList(msg) {
                const emptyMsgDiv = messageList.querySelector('div.text-center');
                if (emptyMsgDiv) emptyMsgDiv.remove();

                const div = document.createElement('div');
                div.className = 'p-3 rounded-lg cursor-pointer hover:bg-indigo-50 border-b border-slate-200 border-l-4 border-transparent transition-colors duration-200';
                div.innerHTML = `
                    <div class="font-semibold text-slate-800">${msg.sender_name}</div>
                    <div class="text-sm text-slate-600 truncate">${msg.subject}</div>
                    <div class="text-xs text-slate-400 mt-1">${new Date(msg.timestamp).toLocaleString('tr-TR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' })}</div>
                `;
                div.addEventListener('click', () => {
                    document.querySelectorAll('#message-list > div').forEach(el => el.classList.remove('selected-message'));
                    div.classList.add('selected-message');
                    displayMessageContent(msg);
                });
                messageList.prepend(div);
            }
            
            // 6. Seçilen mesajın içeriğini sağ panelde gösterir
            function displayMessageContent(msg) {
                messageView.innerHTML = `
                    <div class="border-b border-slate-200 pb-4">
                        <h2 class="text-2xl font-bold text-slate-900">${msg.subject}</h2>
                        <div class="flex items-center justify-between mt-4">
                            <p class="text-sm font-semibold text-slate-700">Kimden: <span class="font-normal">${msg.sender_name}</span></p>
                            <p class="text-sm text-slate-500">${new Date(msg.timestamp).toLocaleString('tr-TR')}</p>
                        </div>
                    </div>
                    <div class="mt-6 text-slate-800 whitespace-pre-wrap leading-relaxed">${msg.content}</div>
                `;
            }

            // 7. Yeni mesaj gönderme
            async function sendMessage(event) {
                event.preventDefault();
                
                const messageData = {
                    sender_id: currentUser.id,
                    receiver_id: parseInt(composeTo.value),
                    subject: document.getElementById('compose-subject').value,
                    content: document.getElementById('compose-body').value
                };

                if (!messageData.receiver_id) {
                    alert('Lütfen bir alıcı seçin.');
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/messages`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(messageData)
                    });

                    if (response.ok) {
                        alert('Mesaj başarıyla gönderildi!');
                        composeForm.reset();
                    } else {
                        const errorData = await response.json().catch(() => response.text());
                        const detail = typeof errorData === 'object' ? errorData.detail : errorData;
                        console.error("Mesaj gönderilemedi:", detail);
                        alert(`Mesaj gönderilemedi: ${detail || "Bilinmeyen sunucu hatası."}`);
                    }
                } catch (error) {
                    console.error('Mesaj gönderilirken ağ hatası:', error);
                    alert('Sunucuya bağlanırken bir hata oluştu.');
                }
            }


            // --- OLAY DİNLEYİCİLERİ ---
            userSelect.addEventListener('change', (e) => {
                handleUserLogin(e.target.value);
            });

            composeForm.addEventListener('submit', sendMessage);

            // --- BAŞLANGIÇ ---
            populateUsers();
        });
    </script>
</body>
</html>
